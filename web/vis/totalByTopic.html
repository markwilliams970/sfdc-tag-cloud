<script type="text/javascript">
  //var vis = angular.module('fdvis.totalByUsers', ['fdvis']);

function TotalsByTopicController(fdVisualizationData) {
  var
    usersByID,
    normalizedData,
    width = 1400,
    height = 900,
    format = d3.format(",d"),
    color = d3.scale.category20c();

  console.log(fdVisualizationData);

  topicsByName = _.indexBy(fdVisualizationData.topics, 'TopicName');
  topicTotalMessages = _.groupBy(fdVisualizationData.topics, 'TopicName');
  console.log(topicsByName);
  console.log(topicTotalMessages);

  normalizedData = _(topicTotalMessages).transform(function (result, topicAssignments, topic) {
    if (topicsByName[topic]) {
      result[topicsByName[topic].TopicName] = {
        value: topicAssignments.length,
        topicName: topicsByName[topic].TopicName
      };
    }
  }).map(function (val) { return val; }).value();

  var bubble = d3.layout.pack()
    .sort(null)
    .size([width, height])
    .padding(1.5);

  var svg = d3.select("#chart").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "bubble");

  d3.select(self.frameElement).style("height", height + "px");

  var node = svg.selectAll(".node")
      .data(bubble.nodes({children: normalizedData})
      .filter(function (d) { return !d.children; }))
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  node.append("title")
    .text(function(d) { return d.username + ": " + format(d.value); });

  node.append("circle")
    .attr("r", function(d) { return d.r; })
    .style("fill", function(d) { return color(d.value); });

  node.append("text")
    .attr("dy", ".3em")
    .style("text-anchor", "middle")
    .text(function(d) { return d.topicName.substring(0, d.r / 2); });


}
</script>
<div data-ng-controller="TotalsByTopicController" id="chart">

</div>
